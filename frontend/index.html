<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Playwright Test Runner</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div id="background-code"></div>

    <input type="text" id="analyze-url" placeholder="Analiz edilecek URL" style="width: 60%; padding: 8px;" />
    <button id="analyze">Sayfayı Tara</button>

    <h3 style="margin-top: 20px;">JSON Adımları (Otomatik veya Manuel)</h3>
    <textarea id="steps" rows="15" style="width: 100%; margin-top: 5px;"></textarea>
    <button id="run" style="margin-top: 10px;">Testi Çalıştır</button>

    <h3 style="margin-top: 30px;">Doğal Dil Test Senaryosu</h3>
    <textarea id="nlp-steps" rows="10" style="width: 100%; margin-top: 5px;"></textarea>
    <button id="run-nlp" style="margin-top: 10px;">Doğal Testi Çalıştır</button>

    <div id="loading" style="margin-top: 20px;"></div>
    <div id="results"></div>

    <script>
        document.getElementById("analyze").onclick = async () => {
            const url = document.getElementById("analyze-url").value;
            if (!url) {
                alert("Lütfen bir URL girin");
                return;
            }

            document.getElementById("loading").textContent = "Sayfa analiz ediliyor...";
            document.getElementById("results").innerHTML = "";

            try {
                const res = await fetch("http://127.0.0.1:8002/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url }),
                });

                const data = await res.json();
                const stepsJson = JSON.stringify(data.steps, null, 2);
                document.getElementById("steps").value = stepsJson;
                document.getElementById("loading").textContent = `✅ ${data.steps.length} adım üretildi`;
            } catch (error) {
                document.getElementById("loading").textContent = "";
                console.error("❌ Analyze hatası:", error);
                alert("Analyze sırasında bir hata oluştu: " + error.message);
            }
        };

        document.getElementById("run").onclick = async () => {
            const stepsText = document.getElementById("steps").value;
            let steps;

            try {
                steps = JSON.parse(stepsText);
                if (Array.isArray(steps) && steps.length === 1 && Array.isArray(steps[0])) {
                    steps = steps[0];
                }
            } catch {
                alert("Geçersiz JSON formatı");
                return;
            }

            document.getElementById("loading").textContent = "Test çalışıyor, lütfen bekleyin...";
            document.getElementById("results").innerHTML = "";

            try {
                const res = await fetch("http://127.0.0.1:8002/run-test", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ steps }),
                });

                if (!res.ok) throw new Error(`HTTP Hatası: ${res.status}`);
                const data = await res.json();
                document.getElementById("loading").textContent = "";

                const resultsContainer = document.getElementById("results");
                resultsContainer.innerHTML = "";

                data.results.forEach(r => {
                    const div = document.createElement("div");
                    div.className = "result-item";
                    if (r.status === "fail") div.classList.add("fail");

                    const stepText = document.createElement("p");
                    stepText.className = "step-text";
                    stepText.textContent = r.step;
                    div.appendChild(stepText);

                    if (r.status === "fail" && r.error) {
                        const errorText = document.createElement("p");
                        errorText.textContent = "Hata: " + r.error;
                        errorText.style.color = "#ff5555";
                        div.appendChild(errorText);
                    }

                    if (r.screenshot) {
                        const imgSrc = "data:image/png;base64," + r.screenshot;
                        const img = document.createElement("img");
                        img.src = imgSrc;
                        img.className = "result-screenshot";
                        img.style.cursor = "pointer";
                        img.onclick = () => {
                            const newWindow = window.open();
                            if (newWindow) {
                                newWindow.document.write(`
                  <html><head><title>Ekran Görüntüsü</title></head>
                  <body style="margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh;">
                    <img src="${imgSrc}" style="max-width:100vw; max-height:100vh;"/>
                  </body></html>
                `);
                                newWindow.document.close();
                            } else {
                                alert("Yeni sekme açılamadı. Lütfen popup engelleyiciyi kontrol edin.");
                            }
                        };
                        div.appendChild(img);
                    }

                    resultsContainer.appendChild(div);
                });
            } catch (error) {
                document.getElementById("loading").textContent = "";
                console.error("❌ Fetch hatası:", error);
                alert("Fetch sırasında bir hata oluştu: " + error.message);
            }
        };

        document.getElementById("run-nlp").onclick = async () => {
            const stepsText = document.getElementById("nlp-steps").value;

            if (!stepsText.trim()) {
                alert("Lütfen doğal dil adımlarını girin.");
                return;
            }

            document.getElementById("loading").textContent = "Doğal adımlar çözülüyor...";
            document.getElementById("results").innerHTML = "";

            try {
                const res = await fetch("http://127.0.0.1:8002/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ steps_text: stepsText }),
                });

                const data = await res.json();
                const stepsJson = JSON.stringify(data.steps, null, 2);
                document.getElementById("steps").value = stepsJson;
                document.getElementById("loading").textContent = `✅ ${data.steps.length} adım üretildi`;
            } catch (error) {
                document.getElementById("loading").textContent = "";
                console.error("❌ NLP Analyze hatası:", error);
                alert("Doğal dil çözümlemesi sırasında hata: " + error.message);
            }
        };
    </script>

    <script>
        const bg = document.getElementById("background-code");
        const codeSnippets = [
            "const x = 10;",
            "function test() { return true; }",
            "console.log('Hello world');",
            "let i = 0;",
            "while(i < 5) { i++; }",
            "if (x > 5) { alert(x); }",
            "return false;",
            "// Kayan kod örneği",
            "for(let j=0;j<10;j++){console.log(j);}",
            "async function run(){await fetch('api');}"
        ];

        for (let i = 0; i < 100; i++) {
            const line = document.createElement("div");
            line.className = "code-line";
            line.style.left = (Math.random() * 90 + 5) + "%";
            line.style.animationDuration = (2 + Math.random() * 2) + "s";
            line.style.animationDelay = (Math.random() * 30) + "s";
            line.textContent = codeSnippets[i % codeSnippets.length];
            bg.appendChild(line);
        }
    </script>
</body>

</html>